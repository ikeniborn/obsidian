name: Changelog Validator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master
      - dev

jobs:
  validate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for CHANGELOG.md updates
        id: changelog_check
        run: |
          # Skip for dependabot and automated PRs
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "Skipping changelog check for dependabot"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if CHANGELOG.md was modified
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          if echo "$CHANGED_FILES" | grep -q "CHANGELOG.md"; then
            echo "✅ CHANGELOG.md was updated"
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "⚠️ CHANGELOG.md was not updated"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate changelog format
        if: steps.changelog_check.outputs.skip == 'false'
        run: |
          # Check if CHANGELOG.md has proper structure
          if ! grep -q "^## \[" CHANGELOG.md; then
            echo "❌ CHANGELOG.md missing version entries"
            exit 1
          fi

          # Check if the latest entry has a date
          if ! grep -q "^## \[.*\] - [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}" CHANGELOG.md; then
            echo "❌ Latest CHANGELOG.md entry missing proper date format"
            exit 1
          fi

          echo "✅ CHANGELOG.md format is valid"

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Changelog Update Required**\n\nPlease update CHANGELOG.md with your changes following the format:\n\n```markdown\n## [Version] - YYYY-MM-DD\n\n### Category\n- Your change description\n```\n\nCategories: Added, Changed, Fixed, Security, Breaking Changes'
            })
