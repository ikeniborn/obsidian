# Smart Deployment Guide

**–î–∞—Ç–∞:** 2025-12-30
**–í–µ—Ä—Å–∏—è:** 2.1.0

---

## –û–±–∑–æ—Ä

–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–µ–ø–ª–æ—è —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ rsync –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–µ—Ä—Å–∏–π Docker –æ–±—Ä–∞–∑–æ–≤.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ **Rsync —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
‚úÖ **–£–º–Ω—ã–π Docker pull** - –û–±—Ä–∞–∑—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π –æ–±—Ä–∞–∑–æ–≤ –∏ git –∫–æ–º–º–∏—Ç–æ–≤
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
‚úÖ **–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –ë—ç–∫–∞–ø—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ `.rsync-backups/`

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —É–º–Ω—ã–π –¥–µ–ø–ª–æ–π

### 1. Rsync –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è rsync —Å mirror-—Ä–µ–∂–∏–º–æ–º:

```bash
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (copy_scripts_to_workdir):
cp -r ~/obsidian/* /opt/notes/

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (rsync_deployment_files):
rsync -avhP --delete --backup \
    --exclude=".env" \
    --exclude="data/" \
    ~/obsidian/ /opt/notes/
```

**–ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è:**
- docker-compose*.yml (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
- scripts/ (—Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è –∏ –±—ç–∫–∞–ø–æ–≤)
- templates/ (—à–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
- nostr-relay/config.toml (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nostr Relay)
- local.ini (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CouchDB)
- serverpeer/ (–∏—Å—Ö–æ–¥–Ω–∏–∫–∏ ServerPeer)

**–ß—Ç–æ –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è):**
- `.env` (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `data/` (–¥–∞–Ω–Ω—ã–µ CouchDB)
- `backups/` (—Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏)
- `logs/` (–ª–æ–≥–∏)
- `nostr-relay-data/` (–±–∞–∑–∞ Nostr Relay)
- `serverpeer-vault*/` (vault –¥–∞–Ω–Ω—ã–µ ServerPeer)
- `nginx/ssl/` (SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π Docker –æ–±—Ä–∞–∑–æ–≤

–ü–µ—Ä–µ–¥ pull –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è digest –æ–±—Ä–∞–∑–∞:

```bash
# –õ–æ–∫–∞–ª—å–Ω—ã–π digest
docker inspect --format='{{index .RepoDigests 0}}' couchdb:3.3
# sha256:abc123...

# –£–¥–∞–ª–µ–Ω–Ω—ã–π digest
docker manifest inspect couchdb:3.3 | grep digest
# sha256:abc123...

# –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí skip pull
# –ï—Å–ª–∏ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è ‚Üí pull update
```

**–û–±—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è:**
- `couchdb:3.3` (–µ—Å–ª–∏ CouchDB backend)
- `scsibug/nostr-rs-relay:latest` (–µ—Å–ª–∏ ServerPeer backend)
- `denoland/deno:bin` (–¥–ª—è ServerPeer)
- `node:22.14-bookworm-slim` (–¥–ª—è ServerPeer)

### 3. Deployment Lockfile

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `deployment.lock`:

```json
{
  "deployment": {
    "timestamp": "2025-12-30T10:30:00Z",
    "git_commit": "76a113c",
    "deployed_by": "user@hostname"
  },
  "docker_images": {
    "couchdb": {
      "image": "couchdb:3.3",
      "digest": "sha256:abc123..."
    },
    "nostr_relay": {
      "image": "scsibug/nostr-rs-relay:latest",
      "digest": "sha256:def456..."
    }
  },
  "config_checksums": {
    "env_file": "md5sum_hash",
    "nostr_config": "md5sum_hash",
    "couchdb_config": "md5sum_hash"
  }
}
```

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–ø–ª–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```
üìä Deployment changes since last deployment:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîÑ Git commit: 5aaafb1 ‚Üí 76a113c
üîÑ Image nostr_relay: updated
‚úÖ Git commit: unchanged (76a113c)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π (smart update)

```bash
cd ~/obsidian
git pull origin dev
./deploy.sh
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (dry-run)
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏–∏ –æ–±—Ä–∞–∑–æ–≤
- –°–∫–∞—á–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç deployment.lock

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π pull –æ–±—Ä–∞–∑–æ–≤

```bash
./deploy.sh --force-pull
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è Docker daemon proxy
- –ü—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
- –î–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ latest

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø—Ä–∞–≤–∫–∏

```bash
./deploy.sh --help
```

---

## –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è (–ø–æ—à–∞–≥–æ–≤–æ)

### –®–∞–≥ 1: Git Update

```bash
cd ~/obsidian
git pull origin dev
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
./deploy.sh
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:

```
üîÑ Synchronizing files from ~/obsidian to /opt/notes...
üìã Changes that will be applied:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
>f+++++++++ scripts/deploy-helpers.sh
>f.st...... nostr-relay/config.toml
.d..t...... scripts/
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Apply these changes? (Y/n):
```

–°–∏–º–≤–æ–ª—ã rsync:
- `>f+++` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª
- `>f.st` - –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä –∏–ª–∏ –≤—Ä–µ–º—è
- `.d..t` - –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è

### –®–∞–≥ 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

```
Apply these changes? (Y/n): y
```

### –®–∞–≥ 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```
‚úÖ Files synchronized successfully
‚úÖ Script permissions updated
```

–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
```
/opt/notes/.rsync-backups/20251230_103000/
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤

```
üîç Checking if image needs update: couchdb:3.3
‚úÖ Image is up-to-date (digest: sha256:abc123...)
‚è≠Ô∏è  Skipping pull (image up-to-date): couchdb:3.3

üîç Checking if image needs update: scsibug/nostr-rs-relay:latest
üì• Update available
   Local:  sha256:abc123...
   Remote: sha256:def456...
üîÑ Pulling updated image: scsibug/nostr-rs-relay:latest
```

### –®–∞–≥ 6: –î–µ–ø–ª–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–û–±—ã—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π).

### –®–∞–≥ 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ lockfile

```
üíæ Saving deployment version information...
‚úÖ Lockfile saved: /opt/notes/deployment.lock

üìä Deployment changes since last deployment:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîÑ Git commit: 5aaafb1 ‚Üí 76a113c
üîÑ Image nostr_relay: updated
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

---

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–∞—Ç —Ñ–∞–π–ª–æ–≤ –∏–∑ rsync-backup

```bash
# –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
ls -lt /opt/notes/.rsync-backups/
# 20251230_103000/

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
sudo cp /opt/notes/.rsync-backups/20251230_103000/nostr-relay/config.toml \
    /opt/notes/nostr-relay/config.toml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker restart notes-nostr-relay
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ git

```bash
cd ~/obsidian
git log --oneline -5
# 76a113c fix(nostr-relay): disable authorization
# 5aaafb1 docs: update README

# –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É
git checkout 5aaafb1

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –¥–µ–ø–ª–æ–π
./deploy.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–∫–∞—Ç deployment.lock

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π lockfile
cat /opt/notes/deployment.lock.previous | jq .

# –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º
diff <(cat /opt/notes/deployment.lock | jq .) \
     <(cat /opt/notes/deployment.lock.previous | jq .)
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: rsync command not found

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å rsync
sudo apt-get update
sudo apt-get install -y rsync

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å install.sh –∑–∞–Ω–æ–≤–æ
sudo ./install.sh
```

### –û—à–∏–±–∫–∞: Cannot determine remote image digest

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö registry. Pull –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑.

```
‚ö†Ô∏è  Cannot determine remote image digest, skipping pull
üí° Using cached local image
```

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:
```bash
./deploy.sh --force-pull
```

### –û—à–∏–±–∫–∞: Deployment file sync cancelled

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ prompt "Apply these changes? (Y/n): n"

–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ prompt:
```bash
# –ò–∑–º–µ–Ω–∏—Ç—å sync_deployment_files –≤ deploy.sh
# –£–±—Ä–∞—Ç—å –±–ª–æ–∫ —Å read -p
```

### –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ rsync

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤:

```
>f+++++++++ scripts/deploy-helpers.sh
>f.st...... deploy.sh
>f.st...... install.sh
...
```

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä—ã–º deploy.sh

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ä—ã–π | –ù–æ–≤—ã–π |
|---------|--------|-------|
| –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ | `cp -r` | `rsync --delete --backup` |
| Pull –æ–±—Ä–∞–∑–æ–≤ | –í—Å–µ–≥–¥–∞ | –¢–æ–ª—å–∫–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ |
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | –ù–µ—Ç | deployment.lock |
| –û—Ç–∫–∞—Ç | –¢–æ–ª—å–∫–æ git | git + rsync-backups |
| –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ | –ù–µ—Ç | –ü–æ–∫–∞–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π + prompt |
| –°–∫–æ—Ä–æ—Å—Ç—å –¥–µ–ø–ª–æ—è | ~2 –º–∏–Ω | ~1 –º–∏–Ω (–µ—Å–ª–∏ –Ω–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π) |
| –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ—Ñ–∏–∫–∞ | –ù–µ—Ç | –î–æ 90% (–ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ–±—Ä–∞–∑–æ–≤) |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä lockfile

```bash
cat /opt/notes/deployment.lock | jq .
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö lockfile

```bash
jq -s '.[0] * .[1]' \
    /opt/notes/deployment.lock.previous \
    /opt/notes/deployment.lock
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö rsync-backups

```bash
# –£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
find /opt/notes/.rsync-backups/ -type d -mtime +7 -exec rm -rf {} +
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–µ–∑ prompt

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `deploy.sh`, —Ñ—É–Ω–∫—Ü–∏—é `sync_deployment_files`:

```bash
# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ —Å read -p
# read -p "Apply these changes? (Y/n): " -n 1 -r
# ...
```

---

## FAQ

**Q: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å rsync --delete?**
A: –î–∞, –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∏—Å–∫–ª—é—á–µ–Ω—ã —á–µ—Ä–µ–∑ --exclude. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (.env, data/, backups/) –Ω–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.

**Q: –ß—Ç–æ –µ—Å–ª–∏ rsync —É–¥–∞–ª–∏—Ç —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ?**
A: –í—Å–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `.rsync-backups/`. –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.

**Q: –ü–æ—á–µ–º—É –æ–±—Ä–∞–∑—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è?**
A: –ï—Å–ª–∏ digest —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º - –æ–±—Ä–∞–∑ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--force-pull` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ pull.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å smart pull?**
A: –î–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--force-pull` –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `FORCE_PULL=true` –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏.

**Q: –ö–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è deployment.lock?**
A: –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è. –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ `.previous`.

---

## –°–º–æ—Ç—Ä–∏—Ç–µ —Ç–∞–∫–∂–µ

- [DEPLOYMENT-INSTRUCTIONS.md](DEPLOYMENT-INSTRUCTIONS.md) - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é Nostr Relay fix
- [docs/architecture/](architecture/) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [CLAUDE.md](../CLAUDE.md) - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Claude Code

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0.0
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-30
